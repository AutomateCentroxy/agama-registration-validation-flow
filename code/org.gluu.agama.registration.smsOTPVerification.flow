//  Start subflow for user otp code validation
Flow org.gluu.agama.registration.smsOTPVerification
     Basepath ""
     Inputs userRegistrationService phone
//  Log flow imputs provided by the flow caller.
Log "@info Information received from the caller: " phone
//  Declare a variable for UI feedback messages.
otpUiFeedback = {}
otpUiFeedback.phone = phone
otpUiFeedback.infoMessage = "An OTP code has been send to you on your mobile phone."
//  Try collecting the OTP code from the UI for maximum x(3) times.
Repeat 3 times max
     //  Show UI to collect OTP code from user.
     otpCreds = RRF "smsOtp.ftlh" otpUiFeedback
     //  Add log entry with collected code in log file.
     Log "@info Information provided by the user is : " otpCreds
     When 
          //  Validate the OTP code provided by the user.
          otpValidationResult = Call userRegistrationService validateOTPCode otpCreds.code phone
          Log "@ " __________
     //  Log new code request
     Log "@info User has requested a new code."
     //  Resend OTP code to user
     resendHasSucceed = Call userRegistrationService sendOTPCode phone
//   Maximum attempts reached. OTP validation failed!
Log "@error Maximum attempts reached. OTP validation failed!"
Finish otpUiFeedback