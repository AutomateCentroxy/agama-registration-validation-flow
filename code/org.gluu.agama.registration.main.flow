// User Registration Techniques
Flow org.gluu.agama.registration.main
     Basepath ""
     Timeout 360 seconds
// Create  variable for UI feedback
uiFeedback = {}
sendMail = true
emailObj = {}
uiInput = {matches: true, resent: false}
userData.context = { location: uiInput.location, timeZone: uiInput.zone, device: uiInput.device }
// Iterate x times max
Repeat 6 times max
     // Retrieve user profile  from UI
     userInput = RRF "profile.ftlh" uiFeedback
     // create an instance of Registration service
     userRegistrationService = Call org.gluu.agama.user.UserRegistration#getInstance 
     // Assign userName, email and password  to a variable
     email = userInput.mail
     userName = userInput.uid
     userPassword = userInput.userPassword
     referralCode = userInput.referralCode
     residenceCountry = userInput.residenceCountry
     // Check user name policy
     isUsernamePolicyMatch = Call userRegistrationService usernamePolicyMatch userName
     // if username policy match
     When isUsernamePolicyMatch is true
          // Password policy check
          isPasswordPolicyMatch = Call userRegistrationService passwordPolicyMatch userPassword
          // if password policy match
          When isPasswordPolicyMatch is true
               // Matching password 
               When userInput.userPassword is userInput.confirmPassword
                    // Check user already exist or not with mail
                    user = Call userRegistrationService getUserEntityByMail email
                    // If user not found
                    When user.empty is true
                         // Check user already exist or not with username
                         userWithUid = Call userRegistrationService getUserEntityByUsername userName
                         // user not found
                         When userWithUid.empty is true
                              // Call email service to send mail
                              otpCode = Call userRegistrationService sendEmail email context
                              // When OTP code null
                              When otpCode is null
                                   // Variable assignment for unsuccessful Email delivery
                                   emailObj = { success: false, error: "Unable_to_deliver_e-mail_message" }
                                   Finish emailObj
                              // Variable assignment after successful email delivery
                              emailObj.email = email
                              emailObj.matches = uiInput.matches
                              emailObj.resent = uiInput.resent
                              emailObj.accountExists = existingAccount
                              // Redirect to page asking for OTP received using email
                              uiInput = RRF "emailOtp.ftlh" emailObj
                              uiInput.resent = false
                         Otherwise
                              // User already registered with UID
                              Log "@info User already registered with uid: %" userName
                              // User already registered with UID
                              uiFeedback.errorMessage = "User already registered with this UserName"
                    Otherwise
                         // User already registered with mail
                         Log "@info User already registered with mail: %" email
                         // User already Registered
                         uiFeedback.errorMessage = "User already Registered with this mail"
               Otherwise
                    // Password and Confirm password doesn't match
                    Log "@trace Password and Confirm password doesn't match"
                    // Error variable assignment
                    uiFeedback.errorMessage = "Password and confirm password not matching"
          Otherwise
               // password policy
               uiFeedback.errorMessage = "Password must be at least 6 characters long and contain at least one special character"
     Otherwise
          // Name should contain only alphabets
          uiFeedback.errorMessage = "Name should contain only alphabets"
// Maximum attempt reached
Log "@info Maximum attempt reached"
// User Registration flow failed
it_eqodz = {success:false, error: "User registration flow reached max attempts try later"}
Finish it_eqodz